import{b as p,c as y,g as R,d as U,u as x}from"./tasks-BvUq67hy.js";import{r as c,M as N,o as b,t as u}from"./index-BlCUlzV6.js";const m="http://127.0.0.1:8000/tasks/tasks",F="http://127.0.0.1:8000/tasks/status",L="http://127.0.0.1:8000/tasks/projects",E="http://127.0.0.1:8000/users/department",J=async()=>{try{const r=await u.get(`${L}/`);return console.log("Загрука проектов"),r.data}catch(r){return console.error("Ошибка при получении проекта:",r),null}},M=async()=>{try{const r=await u.get(`${E}/`);return console.log("Полученные отделы:",r.data),r.data}catch(r){return console.error("Ошибка при получении отделов:",r),null}};function z(){const r=c([]),f=c({}),v=c([]),g=c([]),i=c({status_name:"",project:null}),o=c([]),a=N({task_name:"",description:"",documents:null,start_date:"",end_date:"",agreed_with_managers:!1,assigned:14,status:1,priority:1,projects:2,department:1,image:null}),h={1:{priority_name:"НИЗКИЙ",color:"green"},2:{priority_name:"СРЕДНИЙ",color:"blue"},3:{priority_name:"ВЫСОКИЙ",color:"orange"},4:{priority_name:"КРИТИЧЕСКИЙ",color:"red"}},w=async e=>{try{await u.delete(`${F}/${e}/`),console.log("Удаление колонок"),o.value=o.value.filter(t=>t.id!==e)}catch(t){console.error("Ошибка удаления колонки",t)}},T=async e=>{try{await u.delete(`${m}/${e}/`),r.value=r.value.filter(t=>t.id!==e),console.log("Удаление задач")}catch(t){console.error("Ошибка удаления задачи",t)}};function D(e,t){console.log("Перетаскивание задач"),e.dataTransfer.dropEffect="move",e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("taskID",t.id.toString())}async function k(e,t){e.preventDefault();const n=parseInt(e.dataTransfer.getData("taskID"));try{await x(n,t);const s=r.value.find(l=>l.id===n);s&&(s.status=t)}catch(s){console.error("Ошибка при обновлении задачи:",s)}}function j(e){const t=new Date(e);return e?t.toLocaleString("ru-RU",{day:"2-digit",month:"long",hour:"2-digit",minute:"2-digit"}):"Нет даты"}function _(e){if(!e)return null;const t=new Date(e);return isNaN(t)?(console.error("Неправильная дата:",e),null):t.toISOString().split("T")[0]}const I=async()=>{try{if(console.log(" Тип end_date:",typeof a.end_date),!i.value.project){console.error("Ошибка: project не выбран!");return}await U(i.value),i.value.status_name="",i.value.project=null,o.value=await y()}catch(e){console.error("Ошибка при добавлении колонки",e)}},S=async()=>{var e;try{if(console.log("Перед отправкой:",JSON.stringify(a,null,2)),a.end_date=_(a.end_date),!a||!((e=a.task_name)!=null&&e.trim())){console.error("Ошибка: Задание должно быть заполненным");return}if(!a.projects){alert("Выберите проект");return}console.log("Попытка отправки запроса...",JSON.stringify(a,null,2));const t=await u.post(`${m}/`,a);console.log("Ответ сервера:",t.data),r.value.length=0,r.value.push(...await p()),console.log("НОВАЯ ЗАДАЧА",r.value),Object.assign(a,{task_name:"",description:"",documents:null,end_date:"",agreed_with_managers:!1,projects:null,assigned:null,status:1,priority:1,image:null})}catch(t){console.error("Ошибка при добавлении задания",t)}},$=e=>{a.value={...e},a.task_name=e.task_name,a.description=e.description,a.documents=e.documents,a.end_date=e.end_date,a.assigned=e.assigned,a.agreed_with_managers=e.agreed_with_managers,a.status=e.status,a.priority=e.priority,a.projects=e.projects,a.department=e.department,a.image=e.image,showTaskForm.value={...showTaskForm.value,[e.status]:!0}},A=async()=>{try{if(!a.value.id){console.error("Нет ID задачи для обновления");return}console.log("Отправка обновления задачи:",JSON.stringify(a.value,null,2));const e=await u.patch(`${m}/${a.value.id}/`,a.value);console.log("Ответ сервера:",e.data),r.value=await p(),showTaskForm.value={...showTaskForm.value,[task.status]:!0}}catch(e){console.error("Ошибка при обновлении задачи",e)}};function C(e,t){e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("statusID",t.id.toString()),console.log("Перетаскивание колонок: ",t)}const P=(e,t)=>{const n=e.dataTransfer.getData("statusId");if(n&&n!==t.id){const s=o.findIndex(d=>d.id==n),l=o.findIndex(d=>d.id==t.id);if(s!==-1&&l!==-1){const d=o[s];o.splice(s,1),o.splice(l,0,d)}}};function O(e){e.preventDefault()}return b(async()=>{try{const[e,t,n,s,l]=await Promise.allSettled([p(),y(),R(),J(),M()]);e.status==="fulfilled"&&(r.value=e.value),t.status==="fulfilled"&&(o.value=t.value),n.status==="fulfilled"&&(g.value=n.value),s.status==="fulfilled"&&(f.value=s.value),l.status==="fulfilled"&&(v.value=l.value),console.log("Данные загружены:",{tasks:r.value,statuses:o.value,users:g.value,projects:f.value})}catch(e){console.error("Ошибка при загрузке данных:",e)}}),{tasks:r,statuses:o,projects:f,users:g,newStatus:i,newTask:a,priority:h,department:v,updateTask:A,editTask:$,handleClick:w,handleClickTask:T,ondragstart:D,onDrop:k,formatDate:j,formatDateForBackend:_,submitColumn:I,submitTask:S,onColumnDrag:C,onColumnDrop:P,onColumnDragOver:O}}export{z as u};
