import{r as o,o as O,t as r}from"./index-BlCUlzV6.js";const T="http://127.0.0.1:8000/users/api/login/",N="http://127.0.0.1:8000/users/api/logout/",E="http://127.0.0.1:8000/users/api/register",L="http://127.0.0.1:8000/users/positions",b="http://127.0.0.1:8000/users/department",M="http://127.0.0.1:8000/users/company",R="http://127.0.0.1:8000";function z(){const l=o(""),u=o(""),c=o(!1),n=o(""),i=o(""),m=o(""),p=o(""),f=o([]),h=o([]),y=o([]),v=o(null),g=o(null),d=o(null),w=o(null),A=async()=>{var e,a;if(!l.value||!u.value){n.value="Email и пароль обязательны!";return}c.value=!0,n.value="";try{const t=await r.post(`${T}`,{email:l.value,password:u.value});localStorage.setItem("access_token",t.data.access),localStorage.setItem("refresh_token",t.data.refresh),console.log("Access Token Ответ сервера:",JSON.stringify(t.data.access,null,2));const s=t.data.jwt||t.data.access||t.data.token;if(!s){console.error("Токен не получен!");return}localStorage.setItem("authToken",s),r.defaults.headers.common.Authorization=`Bearer ${s}`,console.log("Токен сохранён:",s),console.log("Отправляем запрос с заголовками:",{Authorization:`Bearer ${localStorage.getItem("authToken")}`});const S=await r.get(`${R}/users/api/me/`,{});return console.log("Полученные данные пользователя:",S.data),localStorage.setItem("user",JSON.stringify(S.data)),console.log("Token jwt",s),console.log("Отправляем запрос с заголовком:",{Authorization:`Bearer ${s}`}),!0}catch(t){n.value=((a=(e=t.response)==null?void 0:e.data)==null?void 0:a.message)||"Ошибка авторизации"}finally{c.value=!1}},k=async()=>{var e,a;if(!l.value||!i.value||!m.value||!u.value||!p.value||!v.value||!g.value||!d.value)return n.value="Пожалуйста заполните все поля",!1;c.value=!0,n.value="";try{const t=await r.post(`${E}/`,{email:l.value,first_name:i.value,last_name:m.value,password:u.value,phone_number:p.value,position:v.value,department:g.value,company:d.value});return!0}catch(t){return n.value=((a=(e=t.response)==null?void 0:e.data)==null?void 0:a.message)||"Ошибка при регистрации",!1}finally{c.value=!1}},P=async()=>{try{const e=localStorage.getItem("refresh_token");e&&(console.log("Получение refresh token: ",e),await r.post(`${N}`,{refresh:e}))}catch(e){console.log("Ошибка с logout: ",e)}localStorage.removeItem("refresh_token"),localStorage.removeItem("access_token"),delete r.defaults.headers.common.Authorization,window.location.reload()},_=async()=>{try{const e=await r.get(`${L}/`);return console.log("Загрука список должностей",e.data),e.data}catch(e){return console.error("Ошибка при получении проекта:",e),null}},I=async()=>{try{const e=await r.get(`${b}/`);return console.log("Загрука список отделов"),e.data}catch(e){return console.error("Ошибка при получении проекта:",e),null}},D=async()=>{try{return(await r.get(`${M}/`)).data}catch(e){return console.log("Ошибка загрузки данные о компании"),e}},$=async()=>{await handleLogin()?router.push({name:"profile"}):n.value="Ошибка входа. Проверьте данные."};return O(async()=>{const e=localStorage.getItem("user");if(e)try{const a=JSON.parse(e);userData.value={email:a.email||userData.value.email,first_name:a.first_name||userData.value.first_name,last_name:a.last_name||userData.value.last_name,phone_number:a.phone_number||userData.value.phone_number,position:a.position||userData.value.position,department:a.department||userData.value.department,company:a.company||userData.value.company,image:a.image||userData.value.image},editData.value={...userData.value}}catch(a){console.error("Ошибка при разборе данных пользователя:",a)}try{const[a,t,s]=await Promise.allSettled([_(),I(),D()]);a.status==="fulfilled"&&(f.value=a.value),t.status==="fulfilled"&&(h.value=t.value),s.status=="fulfilled"&&(y.value=s.value),console.log("Данные загружены:",{position:a.value,department:t.value,company:s.value})}catch(a){console.error("Ошибка при загрузке данных:",a)}}),{email:l,first_name:i,last_name:m,phone_number:p,image:w,password:u,isLoading:c,position:f,company:y,department:h,handleLoginClick:$,register:k,login:A,logout:P,errorMessage:n,selectedPosition:v,selectedDepartment:g,selectedCompany:d,getDepartment:I,getCompany:D,getPosition:_}}export{z as U};
