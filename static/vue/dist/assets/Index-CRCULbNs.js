import{g as C,K,r as w,M as h,o as ee,N as S,O as te,b as ne,e as u,f as W,v as d,m as t,F as k,J as D,j as r,G as v,P as O,Q as X,R as le,B as z,S as re,U as oe,x as y,V as U,W as $}from"./index-DAeheIOC.js";import{a as J,b as Y,c as se,u as ae}from"./tasks-BDgb4It9.js";import{g as ie}from"./users-dPhGmGD0.js";import{_ as ue}from"./PageWrapper-BhVuro-9.js";import{C as de}from"./CommentOutlined-8Yb0RgfF.js";var pe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M880 836H144c-17.7 0-32 14.3-32 32v36c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-36c0-17.7-14.3-32-32-32zm-622.3-84c2 0 4-.2 6-.5L431.9 722c2-.4 3.9-1.3 5.3-2.8l423.9-423.9a9.96 9.96 0 000-14.1L694.9 114.9c-1.9-1.9-4.4-2.9-7.1-2.9s-5.2 1-7.1 2.9L256.8 538.8c-1.5 1.5-2.4 3.3-2.8 5.3l-29.5 168.2a33.5 33.5 0 009.4 29.8c6.6 6.4 14.9 9.9 23.8 9.9z"}}]},name:"edit",theme:"filled"};function Z(i){for(var p=1;p<arguments.length;p++){var f=arguments[p]!=null?Object(arguments[p]):{},b=Object.keys(f);typeof Object.getOwnPropertySymbols=="function"&&(b=b.concat(Object.getOwnPropertySymbols(f).filter(function(g){return Object.getOwnPropertyDescriptor(f,g).enumerable}))),b.forEach(function(g){me(i,g,f[g])})}return i}function me(i,p,f){return p in i?Object.defineProperty(i,p,{value:f,enumerable:!0,configurable:!0,writable:!0}):i[p]=f,i}var G=function(p,f){var b=Z({},p,f.attrs);return C(K,Z({},b,{icon:pe}),null)};G.displayName="EditFilled";G.inheritAttrs=!1;const q="http://127.0.0.1:8000/tasks/tasks",fe="http://127.0.0.1:8000/tasks/status",ve="http://127.0.0.1:8000/tasks/projects",ge="http://127.0.0.1:8000/users/department",be=async()=>{try{const i=await S.get(`${ve}/`);return console.log("Загрука проектов"),i.data}catch(i){return console.error("Ошибка при получении проекта:",i),null}},ce=async()=>{try{const i=await S.get(`${ge}/`);return console.log("Полученные отделы:",i.data),i.data}catch(i){return console.error("Ошибка при получении отделов:",i),null}};function ye(){const i=w([]),p=w({}),f=w([]),b=w([]),g=w({status_name:"",user:null}),m=w([]),o=h({task_name:"",description:"",documents:null,start_date:"",end_date:"",agreed_with_managers:!1,assigned:14,status:1,priority:1,projects:2,department:1}),j={1:{priority_name:"НИЗКИЙ",color:"green"},2:{priority_name:"СРЕДНИЙ",color:"blue"},3:{priority_name:"ВЫСОКИЙ",color:"orange"},4:{priority_name:"КРИТИЧЕСКИЙ",color:"red"}},P=async l=>{try{await S.delete(`${fe}/${l}/`),console.log("Удаление колонок"),m.value=m.value.filter(a=>a.id!==l)}catch(a){console.error("Ошибка удаления колонки",a)}},V=async l=>{try{await S.delete(`${q}/${l}/`),i.value=i.value.filter(a=>a.id!==l),console.log("Удаление задач")}catch(a){console.error("Ошибка удаления задачи",a)}};function F(l,a){console.log("Перетаскивание задач"),l.dataTransfer.dropEffect="move",l.dataTransfer.effectAllowed="move",l.dataTransfer.setData("taskID",a.id.toString())}async function E(l,a){l.preventDefault();const e=parseInt(l.dataTransfer.getData("taskID"));try{await ae(e,a);const s=i.value.find(n=>n.id===e);s&&(s.status=a)}catch(s){console.error("Ошибка при обновлении задачи:",s)}}function A(l){const a=new Date(l);return l?a.toLocaleString("ru-RU",{day:"2-digit",month:"long",hour:"2-digit",minute:"2-digit"}):"Нет даты"}function _(l){if(!l)return null;const a=new Date(l);return isNaN(a)?(console.error("Неправильная дата:",l),null):a.toISOString().split("T")[0]}const L=async()=>{try{if(console.log(" Тип end_date:",typeof o.end_date),!g.value.user){console.error("Ошибка: user не выбран!");return}await se(g.value),g.value.status_name="",g.value.user=null,m.value=await Y()}catch(l){console.error("Ошибка при добавлении колонки",l)}},I=async()=>{var l;try{if(console.log("Перед отправкой:",JSON.stringify(o,null,2)),o.end_date=_(o.end_date),!o||!((l=o.task_name)!=null&&l.trim())){console.error("Ошибка: Задание должно быть заполненным");return}if(!o.projects){alert("Выберите проект");return}console.log("Попытка отправки запроса...",JSON.stringify(o,null,2));const a=await S.post(`${q}/`,o);console.log("Ответ сервера:",a.data),i.value.length=0,i.value.push(...await J()),console.log("НОВАЯ ЗАДАЧА",i.value),Object.assign(o,{task_name:"",description:"",documents:null,end_date:"",agreed_with_managers:!1,projects:null,assigned:null,status:1,priority:1})}catch(a){console.error("Ошибка при добавлении задания",a)}},N=l=>{o.value={...l},o.task_name=l.task_name,o.description=l.description,o.documents=l.documents,o.end_date=l.end_date,o.assigned=l.assigned,o.agreed_with_managers=l.agreed_with_managers,o.status=l.status,o.priority=l.priority,o.projects=l.projects,o.department=l.department,showTaskForm.value={...showTaskForm.value,[l.status]:!0}},R=async()=>{try{if(!o.value.id){console.error("Нет ID задачи для обновления");return}console.log("Отправка обновления задачи:",JSON.stringify(o.value,null,2));const l=await S.patch(`${q}/${o.value.id}/`,o.value);console.log("Ответ сервера:",l.data),i.value=await J(),showTaskForm.value={...showTaskForm.value,[task.status]:!0}}catch(l){console.error("Ошибка при обновлении задачи",l)}};function T(l,a){l.dataTransfer.effectAllowed="move",l.dataTransfer.setData("statusID",a.id.toString()),console.log("Перетаскивание колонок: ",a)}const M=(l,a)=>{const e=l.dataTransfer.getData("statusId");if(e&&e!==a.id){const s=m.findIndex(c=>c.id==e),n=m.findIndex(c=>c.id==a.id);if(s!==-1&&n!==-1){const c=m[s];m.splice(s,1),m.splice(n,0,c)}}};function B(l){l.preventDefault()}return ee(async()=>{try{const[l,a,e,s,n]=await Promise.allSettled([J(),Y(),ie(),be(),ce()]);l.status==="fulfilled"&&(i.value=l.value),a.status==="fulfilled"&&(m.value=a.value),e.status==="fulfilled"&&(b.value=e.value),s.status==="fulfilled"&&(p.value=s.value),n.status==="fulfilled"&&(f.value=n.value),console.log("Данные загружены:",{tasks:i.value,statuses:m.value,users:b.value,projects:p.value})}catch(l){console.error("Ошибка при загрузке данных:",l)}}),{tasks:i,statuses:m,projects:p,users:b,newStatus:g,newTask:o,priority:j,department:f,updateTask:R,editTask:N,handleClick:P,handleClickTask:V,ondragstart:F,onDrop:E,formatDate:A,formatDateForBackend:_,submitColumn:L,submitTask:I,onColumnDrag:T,onColumnDrop:M,onColumnDragOver:B}}const ke={class:"flex flex-col gap-4 md:flex-row md:items-center"},De={class:"dashboard"},we={class:"center"},Te=["onDrop"],Ce={class:"status"},Se={class:"status-name"},je=["onClick"],xe=["onDragstart"],Oe={class:"form1"},Ue={style:{margin:"0"}},$e={style:{display:"flex"}},_e=["onClick"],Ie={class:"time-part"},Ne={class:"add-task-container"},Pe=["onClick"],Ve={key:0},Fe=["value"],Ee=["value"],Ae=["value"],Le=["value"],Re={class:"add-list"},Me=["value"],He={__name:"Index",setup(i){const{tasks:p,statuses:f,projects:b,users:g,newStatus:m,newTask:o,priority:j,department:P,handleClick:V,updateTask:F,editTask:E,handleClickTask:A,ondragstart:_,onDrop:L,formatDate:I,submitColumn:N,submitTask:R}=ye(),T=w({}),M=a=>{T.value={...T.value,[a]:!T.value[a]},T.value[a]&&(o.status=a)},B=te(),l=w(Number(B.params.projectId));return(a,e)=>(u(),ne(ue,null,{default:W(()=>[(u(!0),d(k,null,D(r(f).filter(s=>s.project_id===l.value),s=>(u(),d("h1",{key:s.id},v(s.status_name),1))),128)),t("div",ke,[t("div",De,[t("div",we,[(u(!0),d(k,null,D(r(f),s=>(u(),d("div",{key:s.id,onDrop:n=>r(L)(n,s.id),class:"droppable",onDragover:e[11]||(e[11]=O(()=>{},["prevent"])),onDragenter:e[12]||(e[12]=O(()=>{},["prevent"]))},[t("div",Ce,[t("h1",Se,v(s.status_name),1),t("a",{class:"red-button",onClick:n=>r(V)(s.id)},[C(r(X),{style:{"font-size":"15px",color:"red",cursor:"pointer"}})],8,je)]),C(le,{name:"fade"},{default:W(()=>[(u(!0),d(k,null,D(r(p).filter(n=>n.status==s.id&&new Date(n.end_date)>new Date),n=>{var c,H,Q;return u(),d("div",{key:n.id,onDragstart:x=>r(_)(x,n),draggable:"true",class:"draggable"},[t("div",Oe,[t("p",Ue,[z(v(n.task_name)+" ",1),t("span",{style:re({color:(c=r(j)[n.priority])==null?void 0:c.color})}," ("+v(((H=r(j)[n.priority])==null?void 0:H.priority_name)||"Неизвестный")+") ",5)]),t("div",$e,[t("a",{onClick:O(x=>r(A)(n.id),["prevent"]),class:"delete-task"},[C(r(X),{style:{"font-size":"15px",color:"red",cursor:"pointer"}})],8,_e),C(r(G),{style:{"font-size":"15px",color:"green"},onClick:x=>r(E)(n)},null,8,["onClick"])])]),t("div",Ie,[t("p",null,"от "+v(r(I)(n.start_date)),1),t("p",null,"до "+v(r(I)(n.end_date)),1)]),t("p",null,[z(v(n.description)+" ",1),t("p",null,"Создано с "+v(((Q=r(g).find(x=>x.id===n.assigned))==null?void 0:Q.first_name)||"Неизвестно"),1)]),C(r(de),{style:{color:"green",cursor:"pointer"}})],40,xe)}),128))]),_:2},1024),t("div",Ne,[t("a",{onClick:n=>M(s.id),href:"#",class:"add-task"},"Добавить Задачу",8,Pe),T.value[s.id]?(u(),d("div",Ve,[e[45]||(e[45]=t("h2",null,"Форма",-1)),t("form",{onSubmit:e[10]||(e[10]=O(n=>{r(o).id?r(F)():r(R)()},["prevent"]))},[e[16]||(e[16]=t("label",{class:"label-name"},"Название:",-1)),y(t("input",{"onUpdate:modelValue":e[0]||(e[0]=n=>r(o).task_name=n),placeholder:"Название задачи",required:""},null,512),[[U,r(o).task_name]]),e[17]||(e[17]=z("> ")),e[18]||(e[18]=t("br",null,null,-1)),e[19]||(e[19]=t("br",null,null,-1)),e[20]||(e[20]=t("label",{class:"label-name"},"Описание:",-1)),y(t("input",{"onUpdate:modelValue":e[1]||(e[1]=n=>r(o).description=n),placeholder:"Описание задачи"},null,512),[[U,r(o).description]]),e[21]||(e[21]=t("br",null,null,-1)),e[22]||(e[22]=t("br",null,null,-1)),e[23]||(e[23]=t("label",{class:"label-name"},"Прикрепить Файл: ",-1)),t("input",{type:"file",onInput:e[2]||(e[2]=n=>console.log("файл изменилось:"))},null,32),e[24]||(e[24]=t("br",null,null,-1)),e[25]||(e[25]=t("br",null,null,-1)),e[26]||(e[26]=t("label",{class:"label-name"},"Начало:",-1)),y(t("input",{type:"date","onUpdate:modelValue":e[3]||(e[3]=n=>r(o).start_date=n)},null,512),[[U,r(o).start_date]]),e[27]||(e[27]=t("br",null,null,-1)),e[28]||(e[28]=t("br",null,null,-1)),e[29]||(e[29]=t("label",{class:"label-name"},"Конец:",-1)),y(t("input",{type:"date","onUpdate:modelValue":e[4]||(e[4]=n=>r(o).end_date=n)},null,512),[[U,r(o).end_date]]),e[30]||(e[30]=t("br",null,null,-1)),e[31]||(e[31]=t("br",null,null,-1)),e[32]||(e[32]=t("label",null,"Отдел",-1)),y(t("select",{"onUpdate:modelValue":e[5]||(e[5]=n=>r(o).department=n),onChange:e[6]||(e[6]=n=>console.log("отдел: ",r(o).department))},[(u(!0),d(k,null,D(r(P),n=>(u(),d("option",{key:n.id,value:n.id},v(n.department_name),9,Fe))),128))],544),[[$,r(o).department]]),e[33]||(e[33]=t("br",null,null,-1)),e[34]||(e[34]=t("br",null,null,-1)),e[35]||(e[35]=t("label",{class:"label-name"},"Подписан с :",-1)),y(t("select",{id:"users","onUpdate:modelValue":e[7]||(e[7]=n=>r(o).assigned=n)},[(u(!0),d(k,null,D(r(g),n=>(u(),d("option",{key:n.id,value:Number(n.id)},v(n.first_name),9,Ee))),128))],512),[[$,r(o).assigned]]),e[36]||(e[36]=t("br",null,null,-1)),e[37]||(e[37]=t("br",null,null,-1)),e[38]||(e[38]=t("label",{class:"label-name"},"Название проекта:",-1)),y(t("select",{"onUpdate:modelValue":e[8]||(e[8]=n=>r(o).projects=n)},[(u(!0),d(k,null,D(r(b),n=>(u(),d("option",{key:n.id,value:n.id},v(n.project_name),9,Ae))),128))],512),[[$,r(o).projects]]),e[39]||(e[39]=t("br",null,null,-1)),e[40]||(e[40]=t("br",null,null,-1)),e[41]||(e[41]=t("label",{for:""},"Приоритет",-1)),y(t("select",{"onUpdate:modelValue":e[9]||(e[9]=n=>r(o).priority=n)},[(u(!0),d(k,null,D(r(j),(n,c)=>(u(),d("option",{key:c,value:c},v(n.priority_name),9,Le))),128))],512),[[$,r(o).priority]]),e[42]||(e[42]=t("br",null,null,-1)),e[43]||(e[43]=t("br",null,null,-1)),e[44]||(e[44]=t("button",{type:"submit "},"Добавить",-1))],32)])):oe("",!0)])],40,Te))),128)),t("div",Re,[e[49]||(e[49]=t("h2",null,"Добавить колонку",-1)),t("form",{onSubmit:e[15]||(e[15]=O((...s)=>r(N)&&r(N)(...s),["prevent"]))},[y(t("input",{"onUpdate:modelValue":e[13]||(e[13]=s=>r(m).status_name=s),placeholder:"Название колонки",required:""},null,512),[[U,r(m).status_name]]),t("div",null,[e[46]||(e[46]=t("label",{for:"users"},"Сотрудник:",-1)),e[47]||(e[47]=t("br",null,null,-1)),y(t("select",{id:"users","onUpdate:modelValue":e[14]||(e[14]=s=>r(m).user=s)},[(u(!0),d(k,null,D(r(g),s=>(u(),d("option",{key:s.id,value:Number(s.id)},v(s.first_name)+" "+v(s.last_name)+" "+v(s.department?s.department.department_name:"No department"),9,Me))),128))],512),[[$,r(m).user]])]),e[48]||(e[48]=t("button",{type:"submit"},"Добавить",-1))],32)])])])])]),_:1}))}};export{He as default};
